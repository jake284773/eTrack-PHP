{% extends "layouts.single" %}

{% block title %}{{ course.name }}{% endblock %}
{% block mainclass %}col-md-12{% endblock %}

{% block content %}
  <header>
    <ol class="breadcrumb">
      <li><a href="{{ route('home') }}">Home</a></li>
      <li><a href="{{ route('admin.courses.index') }}">Courses</a></li>
      <li><a href="{{ route('admin.courses.show', course.id) }}">{{ course.name }}</a></li>
      <li class="active">Progress tracker</li>
    </ol>
    {% if session_has('successMessage') %}
      <div class="alert alert-success">
        {{ session_get('successMessage') }}
      </div>
    {% endif %}

    {% if session_has('infoMessage') %}
      <div class="alert alert-info">
        {{ session_get('infoMessage') }}
      </div>
    {% endif %}

    {% if session_has('errorMessage') %}
      <div class="alert alert-danger">
        {{ session_get('errorMessage') }}
      </div>
    {% endif %}

    <h1 class="page-header">
      {{ block('title') }}
      <div class="pull-right">
        {% if course.student_groups is not empty %}
          <div class="btn-group">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
              <span class="glyphicon glyphicon-filter"></span>
              Filter by student group <span class="caret"></span>
            </button>
            <ul class="dropdown-menu pull-right" role="menu">
              {% for group in course.student_groups %}
                <li><a
                      href="{{ route('admin.courses.tracker.index', {'courseId': course.id, 'group': group.id}) }}">{{ group.id }}</a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if input_get('group') %}
          <a href="{{ route('admin.courses.tracker.index', course.id) }}" class="btn btn-default">Remove filter</a>
        {% endif %}

        <div class="btn-group">
          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            Unit view <span class="caret"></span>
          </button>
          <ul class="dropdown-menu pull-right" role="menu">
            {% for unit in course.units %}
              <li>
                <a href="{{ route('admin.courses.tracker.unit', [course.id, unit.id]) }}">
                  Unit {{ unit.number }} &mdash; {{ unit.name }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </h1>

    <h2>Progress tracker
      <small>Overall view</small>
    </h2>
  </header>

  {% if course.units.count() != constant('MAX_UNITS', course) %}
    <div class="alert alert-warning">
      <h4><span class="glyphicon glyphicon-warning-sign"></span> Final grades cannot be calculated yet</h4>

      <p>
        This is because the qualification for this course must have
        <strong>{{ constant('MAX_UNITS', course) }}</strong> units to be classified as complete.
      </p>
    </div>
  {% endif %}

  {% if input_get('group') %}
    <div class="alert alert-info">
      <span class="glyphicon glyphicon-info-sign"></span> Filtering by student group:
      <strong>{{ input_get('group') }}</strong>
    </div>
  {% endif %}

  <div class="course-view">
    <table class="table table-responsive table-bordered tracker-table">
      <thead>
      <tr>
        <th rowspan="2">Student</th>
        <th colspan="{{ course.units.count() }}">Units</th>
        <th colspan="3">Grades</th>
        <th colspan="2">UCAS Points</th>
      </tr>
      <tr>
        {% for unit in course.units %}
          <th class="unit" title="{{ unit.fullName }}">
            <a href="{{ route('admin.courses.tracker.unit', [course.id, unit.id]) }}">{{ unit.number }}</a>
          </th>
        {% endfor %}
        {# Main Grades #}
        <th>Final</th>
        <th>Pred.</th>
        <th>Target</th>
        {# UCAS Points #}
        {% if course.level == 3 %}
          <th>Final</th>
          <th>Pred.</th>
        {% endif %}
      </tr>
      </thead>

      <tbody>
      {% for result in results %}
        <tr>
          <td class="student" title="{{ result.student.fullName }}">{{ result.student.shortName }}</td>
          {% for unit in result.units %}
            <td class="grade-{{ unit.grade.slug }}">{{ unit.grade.shortName }}</td>
          {% endfor %}
          <td class="grade-{{ result.finalGrade.slug }}">{{ result.finalGrade.shortName }}</td>
          <td class="grade-{{ result.predictedGrade.slug }}">{{ result.predictedGrade.shortName }}</td>
          <td class="grade-{{ result.targetGrade.slug }}">{{ result.targetGrade.shortName }}</td>
          <td>{{ result.finalUcasPoints }}</td>
          <td>{{ result.predictedUcasPoints }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
